<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <div class="data-container">
        <h1>Displaying Data from Jetson Nano</h1>
        <div class="row">
            <div class="column">
                <table border="1" cellpadding="5">
                    <tr>
                        <th colspan="2">Image</th>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <img id="image" src="" alt="Image" style="max-width: 100%; max-height: 200px; width: auto; height: auto; object-fit: contain;">
                        </td>
                    </tr>
                    <tr>
                        <th colspan="2">Current GPS Coordinates</th>
                    </tr>
                    <tr>
                        <td>Latitude:</td>
                        <td id="latitude"></td>
                    </tr>
                    <tr>
                        <td>Longitude:</td>
                        <td id="longitude"></td>
                    </tr>
                    <tr>
                        <th colspan="2">Accelerometer Info</th>
                    </tr>
                    <tr>
                        <td>X:</td>
                        <td id="accelerometer_x"></td>
                    </tr>
                    <tr> 
                        <td>Y:</td>
                        <td id="accelerometer_y"></td>
                    </tr>
                    <tr>
                        <td>Z:</td>
                        <td id="accelerometer_z"></td>
                    </tr>
                    <tr>
                        <th colspan="2">Control Info</th>
                    </tr>
                    <tr>
                        <td>Speed:</td>
                        <td id="speed"></td>
                    </tr>
                    <tr>
                        <td>Direction:</td>
                        <td id="direction"></td>
                    </tr>
                    <tr>
                        <td>Magnitude:</td>
                        <td id="magnitude"></td>
                    </tr>
                    <tr>
                        <td>Safety:</td>
                        <td id="safety"></td>
                    </tr>
                </table>
            </div>
        
            <div class="column">
                <div id="map" style="height: 400px; width: 400px;"></div>
            </div>
        </div>
        <div class="row">
            <button id="stopFlightButton" onclick="toggleFlight()">Stop Flight</button>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        var mapInitialized = false; // check for track map initialization
        var map; // declare map variable globally
    
        function initMap(startLatitude, startLongitude, destinationLatitude, destinationLongitude) {
            if (!mapInitialized) { // check if map is not already initialized
                map = L.map('map').setView([destinationLatitude, destinationLongitude], 13);
    
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
    
                // custom marker icons for start and destination
                var startIcon = L.icon({
                    iconUrl: '/static/MAP.png',
                    iconSize: [32, 32], 
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                });
    
                var destinationIcon = L.icon({
                    iconUrl: '/static/FLAG.png', 
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32] 
                });
    
                // add markers for start and destination with custom icons
                L.marker([startLatitude, startLongitude], { icon: startIcon }).addTo(map).bindPopup('Start Location');
                // hardcoding destination since real address doesnt exist
                
                const farm_goal_lat =  47.64266351094032;
                const farm_goal_long = -122.14127227922448;
                L.marker([farm_goal_lat, farm_goal_long], { icon: destinationIcon }).addTo(map).bindPopup('Destination Location');
    
                //L.marker([destinationLatitude, destinationLongitude], { icon: destinationIcon }).addTo(map).bindPopup('Destination Location');
    
                mapInitialized = true; // flag to true after initialization
            }
        }
    
    
        // stop flight button 
        function toggleFlight() {
            var button = document.getElementById("stopFlightButton");
            var newDeliveryStatus = button.textContent === "Stop Flight" ? false : true; // delivery status
            button.disabled = true; // disable button to prevent multiple clicks
            fetch('/update_delivery_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    deliveryStatus: newDeliveryStatus,
                }),
            })
            .then(response => response.json())
            .then(data => {
                // change button text and re-enable button after a delay
                setTimeout(function() {
                    button.textContent = newDeliveryStatus ? "Stop Flight" : "Start Flight";
                    button.disabled = false;
                }, 2000); // adjust delay as needed
            })
            .catch(error => {
                console.error('Error:', error);
                button.disabled = false; // show error
            });
        }
    
        // function to fetch data from server and initialize map
        function fetchDataAndInitMap() {
            fetch('/fetch_coordinates')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        // call initMap with start and destination coordinates
                        var startLatitude = parseFloat(data[0]['StartLatitude']['S']);
                        var startLongitude = parseFloat(data[0]['StartLongitude']['S']);
                        var destinationLatitude = parseFloat(data[0]['DestinationLatitude']['S']);
                        var destinationLongitude = parseFloat(data[0]['DestinationLongitude']['S']);
                        initMap(startLatitude, startLongitude, destinationLatitude, destinationLongitude);
                    } else {
                        console.error('No coordinates data found.');
                    }
                })
                .catch(error => console.error('Error fetching coordinates:', error));
        }
        // func to fetch data from server
        function fetchData() {
            fetch('/retrieve_data')
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        // update HTML elements with the latest data
                        document.getElementById('image').src = data['Image']['S'];
                        document.getElementById('latitude').textContent = data['GPS']['M']['latitude']['N'];
                        document.getElementById('longitude').textContent = data['GPS']['M']['longitude']['N'];
    
                        document.getElementById('accelerometer_x').textContent = data['Accelerometer']['M']['x']['N'];
                        document.getElementById('accelerometer_y').textContent = data['Accelerometer']['M']['y']['N'];
                        document.getElementById('accelerometer_z').textContent = data['Accelerometer']['M']['z']['N'];
                        document.getElementById('speed').textContent = data['Control']['M']['mag']['S'];
                        document.getElementById('direction').textContent = data['Control']['M']['direction']['S'];
                        document.getElementById('magnitude').textContent = data['Control']['M']['mag']['S'];
                        document.getElementById('safety').textContent = parseSafetyTensor(data['Control']['M']['Safety']['S']);
                    } else {
                        // if no data is returned, display a message
                        document.getElementById('noDataMsg').style.display = 'block';
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }
    
        // func to parse safety tensor data
        function parseSafetyTensor(safetyString) {
            var values = safetyString.match(/\d+\.\d+/g);
            if (values && values.length >= 2) {
                return  values[0] + ', ' + values[1];
            }
            return 'Safety data not available';
        }
    
    
        var droneMarker;

        // func to update drone marker position
        function updateDroneMarker() {
            fetch('/retrieve_data')
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        const latitude = parseFloat(data['GPS']['M']['latitude']['N']);
                        const longitude = parseFloat(data['GPS']['M']['longitude']['N']);
    
                        // update drone marker position
                        if (droneMarker) {
                            droneMarker.setLatLng([latitude, longitude]);
                        } else {
                            // create drone marker with custom icon
                            var droneIcon = L.icon({
                                iconUrl: '/static/DRONE.png',
                                iconSize: [32, 32],
                                iconAnchor: [16, 32],
                                popupAnchor: [0, -32]
                            });
    
                            // create drone marker
                            droneMarker = L.marker([latitude, longitude], { icon: droneIcon }).addTo(map).bindPopup('Drone Location');
                        }
                    } else {
                        console.error('No data found to update drone marker.');
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }
    
    
        // call updateDroneMarker 
        updateDroneMarker();
        setInterval(updateDroneMarker, 5000); // fetch drone marker every 5 seconds
    
    
        // call fetchData 
        fetchData();
        setInterval(fetchData, 5000); // fetch data every 5 seconds 
    
        // call fetchDataAndInitMap 
        fetchDataAndInitMap();
        setInterval(fetchDataAndInitMap, 5000); // fetch coordinates every 5 seconds
    </script>
    