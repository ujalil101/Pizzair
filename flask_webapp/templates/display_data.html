<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <div class="data-container">
        <h1>Displaying Data from Jetson Nano</h1>
        <div class="row">
            <div class="column">
                <table border="1" cellpadding="5">
                    <tr>
                        <th colspan="2">Image</th>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <img id="image" src="" alt="Image" style="max-width: 100%; max-height: 200px; width: auto; height: auto; object-fit: contain;">
                        </td>
                    </tr>
                    <tr>
                        <th colspan="2">Current GPS Coordinates</th>
                    </tr>
                    <tr>
                        <td>Latitude:</td>
                        <td id="latitude"></td>
                    </tr>
                    <tr>
                        <td>Longitude:</td>
                        <td id="longitude"></td>
                    </tr>
                    <tr>
                        <th colspan="2">Accelerometer Info</th>
                    </tr>
                    <tr>
                        <td>X:</td>
                        <td id="accelerometer_x"></td>
                    </tr>
                    <tr> 
                        <td>Y:</td>
                        <td id="accelerometer_y"></td>
                    </tr>
                    <tr>
                        <td>Z:</td>
                        <td id="accelerometer_z"></td>
                    </tr>
                    <tr>
                        <th colspan="2">Control Info</th>
                    </tr>
                    <tr>
                        <td>Speed:</td>
                        <td id="speed"></td>
                    </tr>
                    <tr>
                        <td>Direction:</td>
                        <td id="direction"></td>
                    </tr>
                    <tr>
                        <td>Magnitude:</td>
                        <td id="magnitude"></td>
                    </tr>
                    <tr>
                        <td>Safety:</td>
                        <td id="safety"></td>
                    </tr>
                </table>
            </div>
        
            <div class="column">
                <div id="map" style="height: 400px; width: 400px;"></div>
            </div>
        </div>
        <div class="row">
            <button id="stopFlightButton" onclick="toggleFlight()">Stop Flight</button>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        var mapInitialized = false; // check for track map initialization

        function initMap(startLatitude, startLongitude, destinationLatitude, destinationLongitude) {
            if (!mapInitialized) { // check if map is not already initialized
                var map = L.map('map').setView([destinationLatitude, destinationLongitude], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Define custom marker icons for start and destination
                var startIcon = L.icon({
                    iconUrl: '/static/MAP.png', // Replace 'start-icon.png' with the path to your start pin icon
                    iconSize: [32, 32], // Adjust icon size as needed
                    iconAnchor: [16, 32], // Adjust icon anchor as needed
                    popupAnchor: [0, -32] // Adjust popup anchor as needed
                });

                var destinationIcon = L.icon({
                    iconUrl: '/static/FLAG.png', // Replace 'destination-icon.png' with the path to your destination pin icon
                    iconSize: [32, 32], // Adjust icon size as needed
                    iconAnchor: [16, 32], // Adjust icon anchor as needed
                    popupAnchor: [0, -32] // Adjust popup anchor as needed
                });

                // Add markers for start and destination with custom icons
                L.marker([startLatitude, startLongitude], { icon: startIcon }).addTo(map).bindPopup('Start Location');
                L.marker([destinationLatitude, destinationLongitude], { icon: destinationIcon }).addTo(map).bindPopup('Destination Location');

                mapInitialized = true; // Set flag to true after initialization
            }
        }


        // stop flight button 
        function toggleFlight() {
            var button = document.getElementById("stopFlightButton");
            var newDeliveryStatus = button.textContent === "Stop Flight" ? false : true; // delivery status
            button.disabled = true; // disable button to prevent multiple clicks
            fetch('/update_delivery_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    deliveryStatus: newDeliveryStatus,
                }),
            })
            .then(response => response.json())
            .then(data => {
                // change button text and re-enable button after a delay
                setTimeout(function() {
                    button.textContent = newDeliveryStatus ? "Stop Flight" : "Start Flight";
                    button.disabled = false;
                }, 2000); // adjust delay as needed
            })
            .catch(error => {
                console.error('Error:', error);
                button.disabled = false; // show error
            });
        }

        // function to fetch data from server and initialize map
        function fetchDataAndInitMap() {
            fetch('/fetch_coordinates')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        document.getElementById('latitude').textContent = data[0]['StartLatitude']['S'];
                        document.getElementById('longitude').textContent = data[0]['StartLongitude']['S'];

                        // Call initMap with start and destination coordinates
                        var startLatitude = parseFloat(data[0]['StartLatitude']['S']);
                        var startLongitude = parseFloat(data[0]['StartLongitude']['S']);
                        var destinationLatitude = parseFloat(data[0]['DestinationLatitude']['S']);
                        var destinationLongitude = parseFloat(data[0]['DestinationLongitude']['S']);
                        initMap(startLatitude, startLongitude, destinationLatitude, destinationLongitude);
                    } else {
                        console.error('No coordinates data found.');
                    }
                })
                .catch(error => console.error('Error fetching coordinates:', error));
        }
        // func to fetch data from server
        function fetchData() {
            fetch('/retrieve_data')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        
                        const latestData = data[0];
                        
                        // update your HTML elements with the latest data
                        document.getElementById('image').src = latestData['Image']['S'];
                        document.getElementById('latitude').textContent = latestData['GPS']['M']['latitude']['N'];
                        document.getElementById('longitude').textContent = latestData['GPS']['M']['longitude']['N'];
                        document.getElementById('accelerometer_x').textContent = latestData['Accelerometer']['M']['x']['N'];
                        document.getElementById('accelerometer_y').textContent = latestData['Accelerometer']['M']['y']['N'];
                        document.getElementById('accelerometer_z').textContent = latestData['Accelerometer']['M']['z']['N'];
                        document.getElementById('speed').textContent = latestData['Control']['M']['mag']['S'];
                        document.getElementById('direction').textContent = latestData['Control']['M']['direction']['S'];
                        document.getElementById('magnitude').textContent = latestData['Control']['M']['mag']['S'];
                        document.getElementById('safety').textContent = parseSafetyTensor(latestData['Control']['M']['Safety']['S']);
                        function parseSafetyTensor(safetyString) {
                            
                            var values = safetyString.match(/\d+\.\d+/g);
                            if (values.length >= 2) {
                                return  values[0] + ', ' + values[1];
                            }
                            return 'Safety data not available';
                        }
                    } else {
                        document.getElementById('noDataMsg').style.display = 'block';
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }
        // declare a global variable to hold the drone marker
        var droneMarker;

        // function to fetch data from server and update drone marker position on the map
        function updateDroneMarker() {
            fetch('/retrieve_data')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const latestData = data[0];
                        const latitude = parseFloat(latestData['GPS']['M']['latitude']['N']);
                        const longitude = parseFloat(latestData['GPS']['M']['longitude']['N']);

                        // Update drone marker position
                        if (droneMarker) {
                            droneMarker.setLatLng([latitude, longitude]);
                        } else {
                            // Create drone marker with custom icon
                            var droneIcon = L.icon({
                                iconUrl: '/static/DRONE.png',
                                iconSize: [32, 32],
                                iconAnchor: [16, 32],
                                popupAnchor: [0, -32]
                            });

                            // Create drone marker
                            droneMarker = L.marker([latitude, longitude], { icon: droneIcon }).addTo(map).bindPopup('Drone Location');
                        }
                    } else {
                        console.error('No data found to update drone marker.');
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // call updateDroneMarker initially and then set an interval to call it periodically
        updateDroneMarker();
        setInterval(updateDroneMarker, 5000); // fetch drone marker every 5 seconds


        // call fetchData initially and then set an interval to call it periodically
        fetchData();
        setInterval(fetchData, 5000); // fetch data every 5 seconds 

        // call fetchDataAndInitMap initially and then set an interval to call it periodically
        fetchDataAndInitMap();
        setInterval(fetchDataAndInitMap, 5000); // fetch coordinates every 5 seconds
    </script>
</body>
</html>
